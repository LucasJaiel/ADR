---
- name: Setup ambiente L4S / Prague
  hosts: all
  become: yes

  vars:
    l4s_kernel_url: "https://github.com/L4STeam/linux/releases/download/testing-build/l4s-testing.zip"
    l4s_tmp_dir: "/tmp/l4s"

  tasks:

    # -----------------------------------------------------
    # 1. Atualização do sistema e pacotes base
    # -----------------------------------------------------
    - name: Atualizar cache do apt
      apt:
        update_cache: yes

    - name: Instalar pacotes base
      apt:
        name:
          - iperf
          - net-tools
          - wget
          - unzip
          - ethtool
          - iproute2
        state: present

    # -----------------------------------------------------
    # 3. Verificação do kernel L4S (Prague)
    # -----------------------------------------------------
    - name: Verificar versão atual do kernel
      command: uname -r
      register: kernel_version
      changed_when: false

    - name: Definir flag se kernel L4S está instalado
      set_fact:
        l4s_installed: "{{ 'prague' in kernel_version.stdout }}"

    # -----------------------------------------------------
    # 4. Download e instalação do kernel L4S (se necessário)
    # -----------------------------------------------------
    - name: Criar diretório temporário
      file:
        path: "{{ l4s_tmp_dir }}"
        state: directory
      when: not l4s_installed

    - name: Baixar kernel L4S
      get_url:
        url: "{{ l4s_kernel_url }}"
        dest: "{{ l4s_tmp_dir }}/l4s.zip"
        mode: '0644'
      when: not l4s_installed

    - name: Descompactar kernel L4S
      unarchive:
        src: "{{ l4s_tmp_dir }}/l4s.zip"
        dest: "{{ l4s_tmp_dir }}"
        remote_src: yes
      when: not l4s_installed

    - name: Instalar pacotes do kernel L4S
      shell: dpkg -i debian_build/*.deb
      args:
        chdir: "{{ l4s_tmp_dir }}"
      when: not l4s_installed

    - name: Atualizar GRUB
      command: update-grub
      when: not l4s_installed

    - name: Reiniciar máquina após instalação do kernel
      reboot:
        reboot_timeout: 600
      when: not l4s_installed

    # -----------------------------------------------------
    # 5. Validação pós-instalação / carregamento
    # -----------------------------------------------------
    - name: Verificar novamente versão do kernel
      command: uname -r
      register: kernel_after_reboot
      changed_when: false

    - name: Garantir que congestion control Prague está disponível
      command: sysctl -w net.ipv4.tcp_congestion_control=prague
      ignore_errors: yes

    - name: Habilitar ECN
      command: sysctl -w net.ipv4.tcp_ecn=3

    # -----------------------------------------------------
    # 6. Configuração opcional de interface (ajuste conforme ambiente)
    # -----------------------------------------------------
    - name: Desativar offloads (TSO, GSO, GRO)
      command: ethtool -K enp0s8 tso off gso off gro off
      ignore_errors: yes

    - name: Configurar FQ qdisc
      command: tc qdisc replace dev enp0s8 root fq
      ignore_errors: yes

    # -----------------------------------------------------
    # 7. Mensagem final
    # -----------------------------------------------------
    - name: Status final do kernel
      debug:
        msg: "Kernel atual: {{ kernel_after_reboot.stdout }}"
